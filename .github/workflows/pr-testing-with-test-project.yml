name: Test using test project
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    paths:
      - '!**/*.md'
      - '!README*'
      - '!CONTRIBUTING*'
      - '!.all-contributorsrc'
      - '!LICENSE'
      - '!CODE_OF_CONDUCT.md'

jobs:
  test:
    if: >
      !github.event.pull_request.draft && !(
        (github.actor == 'asyncapi-bot' && (
          startsWith(github.event.pull_request.title, 'ci: update of files from global .github repo') || 
          startsWith(github.event.pull_request.title, 'chore(release):')
        )) ||
        (github.actor == 'asyncapi-bot-eve' && (
          startsWith(github.event.pull_request.title, 'ci: update of files from global .github repo') || 
          startsWith(github.event.pull_request.title, 'chore(release):')
        )) ||
        (github.actor == 'allcontributors[bot]' && 
          startsWith(github.event.pull_request.title, 'docs: add')
        )
      )
    name: Test generator as dependency with Node ${{ matrix.node }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: ["18", "20"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Run test
        run: NODE_IMAGE_TAG=${{ matrix.node }} docker compose up --abort-on-container-exit --remove-orphans --force-recreate
        working-directory: ./apps/generator/test/test-project
